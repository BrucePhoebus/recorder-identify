!function(p){"use strict";function v(){}var D=function(e){return new t(e)};D.IsOpen=function(){var e=D.Stream;if(e){var t=(e.getTracks&&e.getTracks()||e.audioTracks||[])[0];if(t){var n=t.readyState;return"live"==n||n==t.LIVE}}return!1},D.BufferSize=4096,D.Destroy=function(){for(var e in n)n[e]()};var n={};D.BindDestroy=function(e,t){n[e]=t},D.Support=function(){var e=p.AudioContext;if(!(e=e||p.webkitAudioContext))return!1;var t=navigator.mediaDevices||{};return t.getUserMedia||(t=navigator).getUserMedia||(t.getUserMedia=t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia),!!t.getUserMedia&&(D.Scope=t,D.Ctx&&"closed"!=D.Ctx.state||(D.Ctx=new e,D.BindDestroy("Ctx",function(){var e=D.Ctx;e&&e.close&&e.close()})),!0)},D.SampleData=function(e,t,n,a,r){var i=(a=a||{}).index||0,o=a.offset||0,s=a.frameNext||[],f=(r=r||{}).frameSize||1;r.frameType&&(f="mp3"==r.frameType?1152:1);for(var c=0,u=i;u<e.length;u++)c+=e[u].length;c=Math.max(0,c-Math.floor(o));var l=t/n;1<l?c=Math.floor(c/l):(l=1,n=t),c+=s.length;var p=new Int16Array(c),v=0;for(u=0;u<s.length;u++)p[v]=s[u],v++;for(var m=e.length;i<m;i++){for(var h=e[i],d=(u=o,h.length);u<d;){var S=Math.floor(u),g=Math.ceil(u),_=u-S;p[v]=h[S]+(h[g]-h[S])*_,v++,u+=l}o=u-d}s=null;var y=p.length%f;if(0<y){var M=2*(p.length-y);s=new Int16Array(p.buffer.slice(M)),p=new Int16Array(p.buffer.slice(0,M))}return{index:i,offset:o,frameNext:s,sampleRate:n,data:p}},D.PowerLevel=function(e,t){var n=e/t||0;return n<1251?Math.round(n/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(n/1e4)/Math.log(10)))))};var a=0;function t(e){this.id=++a,D.Traffic&&D.Traffic();var t={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:v};for(var n in e)t[n]=e[n];this.set=t,this._S=9}D.Sync={O:9,C:9},D.prototype=t.prototype={open:function(e,n){var t=this;e=e||v,n=n||v;function a(){e(),t._SO=0}function r(e,t){/Permission|Allow/i.test(e)?n("用户拒绝了录音权限",!0):!1===p.isSecureContext?n("无权录音(需https)"):/Found/i.test(e)?n(t+"，无可用麦克风"):n(t)}var i=D.Sync,o=++i.O,s=i.C;t._O=t._O_=o,t._SO=t._S;function f(){if(s!=i.C||!t._O){var e="open被取消";return o==i.O?t.close():e="open被中断",n(e),1}}if(D.IsOpen())a();else if(D.Support()){var c=function(e){(D.Stream=e)._call={},f()||setTimeout(function(){f()||(D.IsOpen()?(function(){var e=D.Ctx,t=D.Stream,n=t._m=e.createMediaStreamSource(t),a=t._p=(e.createScriptProcessor||e.createJavaScriptNode).call(e,D.BufferSize,1,1);n.connect(a),a.connect(e.destination);var c=t._call;a.onaudioprocess=function(e){for(var t in c){for(var n=e.inputBuffer.getChannelData(0),a=n.length,r=new Int16Array(a),i=0,o=0;o<a;o++){var s=Math.max(-1,Math.min(1,n[o]));s=s<0?32768*s:32767*s,r[o]=s,i+=Math.abs(s)}for(var f in c)c[f](r,i);return}}}(),a()):n("录音功能无效：无音频流"))},100)},u=function(e){var t=e.name||e.message||e.code+":"+e;r(t,"无法录音："+t)},l=D.Scope.getUserMedia({audio:!0},c,u);l&&l.then&&l.then(c)[e&&"catch"](u)}else r("","此浏览器不支持录音")},close:function(e){e=e||v,this._stop();var t=D.Sync;if(this._O=0,this._O_==t.O){t.C++;var n,a=D.Stream;if(a){(n=D.Stream)._m&&(n._m.disconnect(),n._p.disconnect(),n._p.onaudioprocess=n._p=n._m=null);for(var r=a.getTracks&&a.getTracks()||a.audioTracks||[],i=0;i<r.length;i++){var o=r[i];o.stop&&o.stop()}a.stop&&a.stop()}D.Stream=0,e()}else e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.buffers=[e],n.recSize=e.length,n.srcSampleRate=t,n},envStart:function(e,t){var n=this,a=n.set;if(n.isMock=e?1:0,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[],a.sampleRate=Math.min(t,a.sampleRate),n.srcSampleRate=t,n.engineCtx=0,n[a.type+"_start"]){var r=n.engineCtx=n[a.type+"_start"](a);r&&(r.pcmDatas=[],r.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var r=this,i=r.set,o=r.engineCtx,n=r.srcSampleRate,a=e.length,s=D.PowerLevel(t,a),f=r.buffers,c=f.length;f.push(e);var u=Date.now(),l=Math.round(a/n*1e3);r.envInLast=u,1==r.buffers.length&&(r.envInFirst=u-l);var p=r.envInFixTs;p.splice(0,0,{t:u,d:l});for(var v=u,m=0,h=0;h<p.length;h++){var d=p[h];if(3e3<u-d.t){p.length=h;break}v=d.t,m+=d.d}var S=p[1],g=u-v;if(g/3<g-m&&(S&&1e3<g||6<=p.length)){var _=u-S.t-l;if(l/5<_){var y=!i.disableEnvInFix;if(r.envInFix+=_,y){var M=new Int16Array(_*n/1e3);a+=M.length,f.push(M)}}}var x=r.recSize,I=a,R=x+I;if(r.recSize=R,o){var w=D.SampleData(f,n,i.sampleRate,o.chunkInfo);o.chunkInfo=w,R=(x=o.pcmSize)+(I=w.data.length),o.pcmSize=R,f=o.pcmDatas,c=f.length,f.push(w.data),n=w.sampleRate}function C(){for(var e=z?0:-I,t=0,n=c;n<T;n++){var a=f[n];null==a?t=1:(e+=a.length,o&&a.length&&r[i.type+"_encode"](o,a))}t||(o?o.pcmSize+=e:r.recSize+=e)}var b=Math.round(R/n*1e3),T=f.length,z=i.onProcess(f,s,b,n,c,C);if(!0===z){var O=0;for(h=c;h<T;h++)null==f[h]?O=1:f[h]=new Int16Array(0);O||(o?o.pcmSize-=I:r.recSize-=I)}else C()},start:function(){if(D.IsOpen()){var e=this,t=(e.set,D.Ctx);if(e._stop(),e.state=0,e.envStart(0,t.sampleRate),!e._SO||e._SO+1==e._S){e._SO=0;var n=function(){e.state=1,e.resume()};"suspended"==t.state?t.resume().then(function(){n()}):n()}}},pause:function(){this.state&&(this.state=2,delete D.Stream._call[this.id])},resume:function(){var n=this;n.state&&(n.state=1,n.envResume(),D.Stream._call[n.id]=function(e,t){1==n.state&&n.envIn(e,t)})},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(n,t,e){function a(){o._stop(),e&&o.close()}function r(e){t&&t(e),a()}function i(e,t){e.size<Math.max(100,t/2)?r("生成的"+s.type+"无效"):(n&&n(e,t),a())}var o=this,s=o.set;if(!o.isMock){if(!o.state)return void r("未开始录音");o._stop(!0)}var f=o.recSize;if(f)if(o.buffers[0])if(o[s.type]){var c=o.engineCtx;if(o[s.type+"_complete"]&&c){c.pcmDatas;var u=Math.round(c.pcmSize/s.sampleRate*1e3);return Date.now(),void o[s.type+"_complete"](c,function(e){i(e,u)},r)}Date.now();var l=D.SampleData(o.buffers,o.srcSampleRate,s.sampleRate);s.sampleRate=l.sampleRate;var p=l.data;u=Math.round(p.length/s.sampleRate*1e3),setTimeout(function(){Date.now(),o[s.type](p,function(e){i(e,u)},function(e){r(e)})})}else r("未加载"+s.type+"编码器");else r("音频被释放");else r("未采集到录音")}},p.Recorder&&p.Recorder.Destroy(),(p.Recorder=D).LM="2020-1-8 10:53:14",D.TrafficImgUrl="//ia.51.la/go1?id=20469973&pvFlag=1",D.Traffic=function(){var e=D.TrafficImgUrl;if(e){var t=D.Traffic,n=location.href.replace(/#.*/,"");if(!t[n])t[n]=1,(new Image).src=e}}}(window),"function"==typeof define&&define.amd&&define(function(){return Recorder}),"object"==typeof module&&module.exports&&(module.exports=Recorder),function(){"use strict";Recorder.prototype.enc_wav={stable:!0,testmsg:"比特率取值范围8位、16位"},Recorder.prototype.wav=function(e,t,n){function a(e){for(var t=0;t<e.length;t++,v++)p.setUint8(v,e.charCodeAt(t))}function r(e){p.setUint16(v,e,!0),v+=2}function i(e){p.setUint32(v,e,!0),v+=4}var o=this.set,s=e.length,f=o.sampleRate,c=8==o.bitRate?8:16,u=s*(c/8),l=new ArrayBuffer(44+u),p=new DataView(l),v=0;if(a("RIFF"),i(36+u),a("WAVE"),a("fmt "),i(16),r(1),r(1),i(f),i(f*(c/8)),r(c/8),r(c),a("data"),i(u),8==c)for(var m=0;m<s;m++,v++){var h=128+(e[m]>>8);p.setInt8(v,h,!0)}else for(m=0;m<s;m++,v+=2)p.setInt16(v,e[m],!0);t(new Blob([p.buffer],{type:"audio/wav"}))}}();
!function i(a,c,d){function u(t,e){if(!c[t]){if(!a[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(s)return s(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var o=c[t]={exports:{}};a[t][0].call(o.exports,function(e){return u(a[t][1][e]||e)},o,o.exports,i,a,c,d)}return c[t].exports}for(var s="function"==typeof require&&require,e=0;e<d.length;e++)u(d[e]);return u}({1:[function(e,t,n){"use strict";t.exports=e("./recorder-identify").RIdentify},{"./recorder-identify":2}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var r=n.RIdentify=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.recorderConfig={numChannels:1,mimeType:"audio/wav",bitRate:16,sampleRate:16e3};var o=this;Object.assign(this.recorderConfig,t.config);var i=t.url||"/robot/rs/qa/asr",a=1e3*(t.time||21),c=0,d=null,n=null,u=!1;(function(){var e=Recorder({type:o.recorderConfig.mimeType.split("/")[1],bitRate:o.recorderConfig.bitRate,sampleRate:o.recorderConfig.sampleRate,disableEnvInFix:!0,onProcess:function(){}});e.open(function(){n=e},function(e,t){0})})(),function(e,t,n){if(function(){{if("micromessenger"!=navigator.userAgent.toLowerCase().match(/MicroMessenger/i))return;var e=document.createElement("meta");return e.name="viewport",e.content="width=device-width, initial-scale=1, user-scalable=0",document.head.appendChild(e),1}}()){var r;document.getElementById(e).addEventListener("touchstart",function(e){clearTimeout(r),t(),r=setTimeout(function(){n()},a),e.preventDefault()}),document.getElementById(e).addEventListener("touchmove",function(e){n(),clearTimeout(r),r=0}),document.getElementById(e).addEventListener("touchend",function(e){if(n(),clearTimeout(r),0!=r)return!1})}else document.getElementById(e).addEventListener("mousedown",t),document.getElementById(e).addEventListener("mouseup",n)}("rIdentify",function(e){m()?p("IE浏览器暂不支持录音！"):function(){r&&(clearInterval(r),r=null);n&&Recorder.IsOpen()?(n.start(),setTimeout(function(){p(s+".")},200),r=setInterval(function(){p(s+=".")},800),u=!u,c=new Date,d=setInterval(function(){c&&(new Date).getTime()-c.getTime()>=a&&l()},a)):p("未打开录音")}()},function(e){m()?p("IE浏览器暂不支持录音！"):l()}),document.getElementById(document.getElementById("rIdentify").getAttribute("data-search-id")).addEventListener("change",function(e){});var r=null,s="";function l(){clearInterval(r),r=null,s="",n&&n.stop(function(e,t){var n,r;(u=!u,clearInterval(d),c&&(new Date).getTime()-c.getTime()<1e3)?c=0:(c=0,e.size<2e4?p("录音太短不可用！"):(n=e,(r=new FormData).append("file",n,(new Date).getTime()+"."+o.recorderConfig.mimeType.split("/")[1]),function(e){(e=e||{}).type=e.type.toUpperCase()||"GET",e.url=e.url||"",e.async=e.async||!0,e.data=e.data||null,e.success=e.success||function(){},e.error=e.error||function(e){};var t=null;t=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.xhr");if(t.upload.addEventListener("progress",function(e){if(e.lengthComputable)(e.loaded/e.total*100).toFixed(0)},!1),t.addEventListener("readystatechange",function(){4==t.readyState&&200==t.status&&e.success(t.response)}),"POST"===e.type.toUpperCase())t.open(e.type,e.url,e.async),t.send(e.data);else if("GET"===e.type.toUpperCase()){var n=[];for(var r in e.data)n.push(r+"="+e.data[r]);var o=n.join("&");t.open(e.type,e.url+"?"+o,e.async),t.send(null)}}({url:i,type:"post",data:r,processData:!1,contentType:!1,success:function(e){if((e=JSON.parse(e)).data){var t=document.getElementById("rIdentify").getAttribute("data-search-id");t&&(document.getElementById(t).value=e.data,function(e,t){if("object"==(void 0===e?"undefined":y(e)))if(t=t.replace(/^on/i,""),document.all)t="on"+t,e.triggerEvent(t);else{var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!0),e.dispatchEvent(n)}}(document.getElementById(t),"change"))}},error:function(){}})))},function(e){p("录音失败:"+e)})}var f=null;function p(e){var t=document.getElementById("rIdentifyTip");t&&(t.parentNode.removeChild(t),f&&clearTimeout(f)),(t=document.createElement("div")).id="rIdentifyTip",t.style.cssText="position: fixed; top: "+(document.getElementById("rIdentify").getBoundingClientRect().top-20)+"px;left: "+document.getElementById("rIdentify").getBoundingClientRect().left+"px;border-radius: 8px;margin-top: -15px;color: #fff;background-color: #409eff;padding: 5px 0;z-index: 2147483647;";var n=document.createElement("span");n.innerText=e,n.title=e,n.style.cssText="margin: 0 10px;white-space: nowrap;",t.appendChild(n),document.getElementById("rIdentify").parentNode.appendChild(t),f=setTimeout(function(){(t=document.getElementById("rIdentifyTip")).parentNode.removeChild(t)},1e3)}function m(){return window.navigator.userAgentbw&&0<=window.navigator.userAgentbw.indexOf("MSIE")||"ActiveXObject"in window}};new(n.default=r)},{}]},{},[1]);