!function(o){o.URL=o.URL||o.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;function r(t,e){(e=e||{}).sampleBits=e.sampleBits||16,e.sampleRate=e.sampleRate||16e3;var n=new(o.webkitAudioContext||o.AudioContext),a=n.createMediaStreamSource(t),r=(n.createScriptProcessor||n.createJavaScriptNode).apply(n,[4096,1,1]),i={size:0,buffer:[],inputSampleRate:n.sampleRate,inputSampleBits:16,outputSampleRate:e.sampleRate,outputSampleBits:e.sampleBits,input:function(t){this.buffer.push(new Float32Array(t)),this.size+=t.length},compress:function(){for(var t=new Float32Array(this.size),e=0,n=0;n<this.buffer.length;n++)t.set(this.buffer[n],e),e+=this.buffer[n].length;for(var a=parseInt(this.inputSampleRate/this.outputSampleRate),r=t.length/a,i=new Float32Array(r),o=0,s=0;o<r;)i[o]=t[s],s+=a,o++;return i},encodeWAV:function(){function t(t){for(var e=0;e<t.length;e++)o.setUint8(s+e,t.charCodeAt(e))}var e=Math.min(this.inputSampleRate,this.outputSampleRate),n=Math.min(this.inputSampleBits,this.outputSampleBits),a=this.compress(),r=a.length*(n/8),i=new ArrayBuffer(44+r),o=new DataView(i),s=0;if(t("RIFF"),s+=4,o.setUint32(s,36+r,!0),s+=4,t("WAVE"),s+=4,t("fmt "),s+=4,o.setUint32(s,16,!0),s+=4,o.setUint16(s,1,!0),s+=2,o.setUint16(s,1,!0),s+=2,o.setUint32(s,e,!0),s+=4,o.setUint32(s,e*(n/8),!0),s+=4,o.setUint16(s,n/8*1,!0),s+=2,o.setUint16(s,n,!0),s+=2,t("data"),s+=4,o.setUint32(s,r,!0),s+=4,8===n)for(var u=0;u<a.length;u++,s++){var c=(p=Math.max(-1,Math.min(1,a[u])))<0?32768*p:32767*p;c=parseInt(255/(65535/(c+32768))),o.setInt8(s,c,!0)}else for(u=0;u<a.length;u++,s+=2){var p=Math.max(-1,Math.min(1,a[u]));o.setInt16(s,p<0?32768*p:32767*p,!0)}return new Blob([o],{type:"audio/wav"})}};this.start=function(){a.connect(r),r.connect(n.destination)},this.stop=function(){r.disconnect()},this.getBlob=function(){return this.stop(),i.encodeWAV()},this.play=function(t){t.src=o.URL.createObjectURL(this.getBlob())},this.upload=function(t,e){var n=new FormData;n.append("audioData",this.getBlob());var a=new XMLHttpRequest;e&&(a.upload.addEventListener("progress",function(t){e("uploading",t)},!1),a.addEventListener("load",function(t){e("ok",t)},!1),a.addEventListener("error",function(t){e("error",t)},!1),a.addEventListener("abort",function(t){e("cancel",t)},!1)),a.open("POST",t),a.send(n)},r.onaudioprocess=function(t){i.input(t.inputBuffer.getChannelData(0))}}r.throwError=function(t){throw alert(t),new function(){this.toString=function(){return t}}},r.canRecording=null!=navigator.getUserMedia,r.get=function(n,a){if(n){if(!navigator.getUserMedia)return void r.throwErr("当前浏览器不支持录音功能。");navigator.getUserMedia({audio:!0},function(t){var e=new r(t,a);n(e)},function(t){switch(t.code||t.name){case"PERMISSION_DENIED":case"PermissionDeniedError":r.throwError("用户拒绝提供信息。");break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":r.throwError("浏览器不支持硬件设备。");break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":r.throwError("无法发现指定的硬件设备。");break;default:r.throwError("无法打开麦克风。异常信息:"+(t.code||t.name))}})}},o.HZRecorder=r}(window);