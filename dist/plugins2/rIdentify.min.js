!function(p){"use strict";function d(){}var z=function(e){return new t(e)};z.IsOpen=function(){var e=z.Stream;if(e){var t=(e.getTracks&&e.getTracks()||e.audioTracks||[])[0];if(t){var n=t.readyState;return"live"==n||n==t.LIVE}}return!1},z.BufferSize=4096,z.Destroy=function(){for(var e in n)n[e]()};var n={};z.BindDestroy=function(e,t){n[e]=t},z.Support=function(){var e=p.AudioContext;if(!(e=e||p.webkitAudioContext))return!1;var t=navigator.mediaDevices||{};return t.getUserMedia||(t=navigator).getUserMedia||(t.getUserMedia=t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia),!!t.getUserMedia&&(z.Scope=t,z.Ctx&&"closed"!=z.Ctx.state||(z.Ctx=new e,z.BindDestroy("Ctx",function(){var e=z.Ctx;e&&e.close&&e.close()})),!0)},z.SampleData=function(e,t,n,r,a){var i=(r=r||{}).index||0,o=r.offset||0,s=r.frameNext||[],f=(a=a||{}).frameSize||1;a.frameType&&(f="mp3"==a.frameType?1152:1);for(var c=0,u=i;u<e.length;u++)c+=e[u].length;c=Math.max(0,c-Math.floor(o));var l=t/n;1<l?c=Math.floor(c/l):(l=1,n=t),c+=s.length;var p=new Int16Array(c),d=0;for(u=0;u<s.length;u++)p[d]=s[u],d++;for(var v=e.length;i<v;i++){for(var m=e[i],h=(u=o,m.length);u<h;){var g=Math.floor(u),y=Math.ceil(u),S=u-g;p[d]=m[g]+(m[y]-m[g])*S,d++,u+=l}o=u-h}s=null;var x=p.length%f;if(0<x){var I=2*(p.length-x);s=new Int16Array(p.buffer.slice(I)),p=new Int16Array(p.buffer.slice(0,I))}return{index:i,offset:o,frameNext:s,sampleRate:n,data:p}},z.PowerLevel=function(e,t){var n=e/t||0;return n<1251?Math.round(n/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(n/1e4)/Math.log(10)))))};var r=0;function t(e){this.id=++r,z.Traffic&&z.Traffic();var t={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:d};for(var n in e)t[n]=e[n];this.set=t,this._S=9}z.Sync={O:9,C:9},z.prototype=t.prototype={open:function(e,n){var t=this;e=e||d,n=n||d;function r(){e(),t._SO=0}function a(e,t){/Permission|Allow/i.test(e)?n("用户拒绝了录音权限",!0):!1===p.isSecureContext?n("无权录音(需https)"):/Found/i.test(e)?n(t+"，无可用麦克风"):n(t)}var i=z.Sync,o=++i.O,s=i.C;t._O=t._O_=o,t._SO=t._S;function f(){if(s!=i.C||!t._O){var e="open被取消";return o==i.O?t.close():e="open被中断",n(e),1}}if(z.IsOpen())r();else if(z.Support()){var c=function(e){(z.Stream=e)._call={},f()||setTimeout(function(){f()||(z.IsOpen()?(function(){var e=z.Ctx,t=z.Stream,n=t._m=e.createMediaStreamSource(t),r=t._p=(e.createScriptProcessor||e.createJavaScriptNode).call(e,z.BufferSize,1,1);n.connect(r),r.connect(e.destination);var c=t._call;r.onaudioprocess=function(e){for(var t in c){for(var n=e.inputBuffer.getChannelData(0),r=n.length,a=new Int16Array(r),i=0,o=0;o<r;o++){var s=Math.max(-1,Math.min(1,n[o]));s=s<0?32768*s:32767*s,a[o]=s,i+=Math.abs(s)}for(var f in c)c[f](a,i);return}}}(),r()):n("录音功能无效：无音频流"))},100)},u=function(e){var t=e.name||e.message||e.code+":"+e;a(t,"无法录音："+t)},l=z.Scope.getUserMedia({audio:!0},c,u);l&&l.then&&l.then(c)[e&&"catch"](u)}else a("","此浏览器不支持录音")},close:function(e){e=e||d,this._stop();var t=z.Sync;if(this._O=0,this._O_==t.O){t.C++;var n,r=z.Stream;if(r){(n=z.Stream)._m&&(n._m.disconnect(),n._p.disconnect(),n._p.onaudioprocess=n._p=n._m=null);for(var a=r.getTracks&&r.getTracks()||r.audioTracks||[],i=0;i<a.length;i++){var o=a[i];o.stop&&o.stop()}r.stop&&r.stop()}z.Stream=0,e()}else e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.buffers=[e],n.recSize=e.length,n.srcSampleRate=t,n},envStart:function(e,t){var n=this,r=n.set;if(n.isMock=e?1:0,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[],r.sampleRate=Math.min(t,r.sampleRate),n.srcSampleRate=t,n.engineCtx=0,n[r.type+"_start"]){var a=n.engineCtx=n[r.type+"_start"](r);a&&(a.pcmDatas=[],a.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var a=this,i=a.set,o=a.engineCtx,n=a.srcSampleRate,r=e.length,s=z.PowerLevel(t,r),f=a.buffers,c=f.length;f.push(e);var u=Date.now(),l=Math.round(r/n*1e3);a.envInLast=u,1==a.buffers.length&&(a.envInFirst=u-l);var p=a.envInFixTs;p.splice(0,0,{t:u,d:l});for(var d=u,v=0,m=0;m<p.length;m++){var h=p[m];if(3e3<u-h.t){p.length=m;break}d=h.t,v+=h.d}var g=p[1],y=u-d;if(y/3<y-v&&(g&&1e3<y||6<=p.length)){var S=u-g.t-l;if(l/5<S){var x=!i.disableEnvInFix;if(a.envInFix+=S,x){var I=new Int16Array(S*n/1e3);r+=I.length,f.push(I)}}}var _=a.recSize,w=r,T=_+w;if(a.recSize=T,o){var R=z.SampleData(f,n,i.sampleRate,o.chunkInfo);o.chunkInfo=R,T=(_=o.pcmSize)+(w=R.data.length),o.pcmSize=T,f=o.pcmDatas,c=f.length,f.push(R.data),n=R.sampleRate}function M(){for(var e=D?0:-w,t=0,n=c;n<b;n++){var r=f[n];null==r?t=1:(e+=r.length,o&&r.length&&a[i.type+"_encode"](o,r))}t||(o?o.pcmSize+=e:a.recSize+=e)}var C=Math.round(T/n*1e3),b=f.length,D=i.onProcess(f,s,C,n,c,M);if(!0===D){var O=0;for(m=c;m<b;m++)null==f[m]?O=1:f[m]=new Int16Array(0);O||(o?o.pcmSize-=w:a.recSize-=w)}else M()},start:function(){if(z.IsOpen()){var e=this,t=(e.set,z.Ctx);if(e._stop(),e.state=0,e.envStart(0,t.sampleRate),!e._SO||e._SO+1==e._S){e._SO=0;var n=function(){e.state=1,e.resume()};"suspended"==t.state?t.resume().then(function(){n()}):n()}}},pause:function(){this.state&&(this.state=2,delete z.Stream._call[this.id])},resume:function(){var n=this;n.state&&(n.state=1,n.envResume(),z.Stream._call[n.id]=function(e,t){1==n.state&&n.envIn(e,t)})},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(n,t,e){function r(){o._stop(),e&&o.close()}function a(e){t&&t(e),r()}function i(e,t){e.size<Math.max(100,t/2)?a("生成的"+s.type+"无效"):(n&&n(e,t),r())}var o=this,s=o.set;if(!o.isMock){if(!o.state)return void a("未开始录音");o._stop(!0)}var f=o.recSize;if(f)if(o.buffers[0])if(o[s.type]){var c=o.engineCtx;if(o[s.type+"_complete"]&&c){c.pcmDatas;var u=Math.round(c.pcmSize/s.sampleRate*1e3);return Date.now(),void o[s.type+"_complete"](c,function(e){i(e,u)},a)}Date.now();var l=z.SampleData(o.buffers,o.srcSampleRate,s.sampleRate);s.sampleRate=l.sampleRate;var p=l.data;u=Math.round(p.length/s.sampleRate*1e3),setTimeout(function(){Date.now(),o[s.type](p,function(e){i(e,u)},function(e){a(e)})})}else a("未加载"+s.type+"编码器");else a("音频被释放");else a("未采集到录音")}},p.Recorder&&p.Recorder.Destroy(),(p.Recorder=z).LM="2020-1-8 10:53:14",z.TrafficImgUrl="//ia.51.la/go1?id=20469973&pvFlag=1",z.Traffic=function(){var e=z.TrafficImgUrl;if(e){var t=z.Traffic,n=location.href.replace(/#.*/,"");if(!t[n])t[n]=1,(new Image).src=e}}}(window),"function"==typeof define&&define.amd&&define(function(){return Recorder}),"object"==typeof module&&module.exports&&(module.exports=Recorder),function(){"use strict";Recorder.prototype.enc_wav={stable:!0,testmsg:"比特率取值范围8位、16位"},Recorder.prototype.wav=function(e,t,n){function r(e){for(var t=0;t<e.length;t++,d++)p.setUint8(d,e.charCodeAt(t))}function a(e){p.setUint16(d,e,!0),d+=2}function i(e){p.setUint32(d,e,!0),d+=4}var o=this.set,s=e.length,f=o.sampleRate,c=8==o.bitRate?8:16,u=s*(c/8),l=new ArrayBuffer(44+u),p=new DataView(l),d=0;if(r("RIFF"),i(36+u),r("WAVE"),r("fmt "),i(16),a(1),a(1),i(f),i(f*(c/8)),a(c/8),a(c),r("data"),i(u),8==c)for(var v=0;v<s;v++,d++){var m=128+(e[v]>>8);p.setInt8(d,m,!0)}else for(v=0;v<s;v++,d+=2)p.setInt16(d,e[v],!0);t(new Blob([p.buffer],{type:"audio/wav"}))}}(),function i(o,s,f){function c(t,e){if(!s[t]){if(!o[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(u)return u(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var a=s[t]={exports:{}};o[t][0].call(a.exports,function(e){return c(o[t][1][e]||e)},a,a.exports,i,o,s,f)}return s[t].exports}for(var u="function"==typeof require&&require,e=0;e<f.length;e++)c(f[e]);return c}({1:[function(e,t,n){"use strict";t.exports=e("./recorder-identify").RIdentify},{"./recorder-identify":2}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=n.RIdentify=function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};!function(e){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this),this.recorderConfig={numChannels:1,mimeType:"audio/wav",bitRate:16,sampleRate:16e3};var a=this;Object.assign(this.recorderConfig,e.config);var n,i=e.url||"/robot/rs/qa/asr",r=1e3*(e.time||21),o=0,s=null,f=null,c=!1;function u(){f&&f.stop(function(e,t){var n,r;c=!c,clearInterval(s),o&&(new Date).getTime()-o.getTime()<1e3?o=0:(o=0,e.size<2e4?p("录音太短不可用！"):(p("录音结束..."),n=e,(r=new FormData).append("file",n,(new Date).getTime()+"."+a.recorderConfig.mimeType.split("/")[1]),$.ajax({url:i,type:"post",data:r,processData:!1,contentType:!1,success:function(e){e.data&&$("#rIdentify").data("search-id")&&$("#"+$("#rIdentify").data("search-id")).val(e.data)},error:function(e){}})))},function(e){p("录音失败:"+e)})}(n=Recorder({type:a.recorderConfig.mimeType.split("/")[1],bitRate:a.recorderConfig.bitRate,sampleRate:a.recorderConfig.sampleRate,disableEnvInFix:!0,onProcess:function(){}})).open(function(){f=n},function(e,t){p((t?"UserNotAllow，":"")+"打开录音失败："+e)}),$("#rIdentify").click(function(){-1===window.location.href.indexOf("https")&&p("请在https安全状态下使用录音功能！"),void 0!==c?c?u():f&&Recorder.IsOpen()?(f.start(),p("开始录音...再次点击录音终止！"),c=!c,o=new Date,s=setInterval(function(){o&&(new Date).getTime()-o.getTime()>=r&&u()},r)):p("未打开录音"):p("请确认麦克风未被禁用！")});var l=null;function p(e){l&&$("#rIdentifyTip")&&(clearTimeout(l),$("#rIdentifyTip").remove());var t=document.createElement("div");t.id="rIdentifyTip",t.style.cssText="position: absolute; top: "+($("#rIdentify")[0].offsetTop-20)+"px;left: "+$("#rIdentify")[0].offsetLeft+"px;border-radius: 8px;margin-top: -15px;color: #fff;background-color: #409eff;padding: 5px 0;z-index: 2147483647;";var n=document.createElement("span");n.innerText=e,n.style.cssText="margin: 0 10px;",t.appendChild(n),document.getElementById("rIdentify").appendChild(t),l=setTimeout(function(){$("#rIdentifyTip").remove()},2e3)}};new(n.default=r)},{}]},{},[1]);